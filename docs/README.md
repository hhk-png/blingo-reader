 这个项目可以类比为一个编译的流程，编译做的事情是先将文本转换为ast，然后再将ast转换为其他文本。这个项目做的事情是将epub文件转换为ast，然后将ast转换为对应的svg文本文件。

首先是epub的解析，epub实际上是一个zip文件，所以对其进行解析是对zip文件进行操作，现在用的是admzip这个库。里面的书籍信息文件可以简单理解为，有一个目录文件，包括所有资源的描述，以及章节的顺序，先解析目录文件，然后依次将章节信息提取出来。存储章节的文件使用的是xhtml或者html文件，因为结构较为简单，所以这里我将其当做xml文件进行解析，先对标签进行清洗，然后在解析xml，从中提取出数据，解析xml用的是xml2js这个库。

解析出来的数据结构是一个扁平化的数组，每个item是一个token，按照文章的上下结构排列，比如说一段文本的token是type为para，text为对应文本的对象，图像的token是包括对应src，alt等属性的对象。
渲染模块的输入就是前面说的token数组，渲染模块做的事情是将这些输入渲染到svg上面，虽然简单来讲渲染做的事情就是svg字符的拼接，但是在拼接之前还需要进行文本位置的测量，比如每个字需要计算出x和y坐标，图片需要根据图片大小计算出长宽和xy坐标。因为没有用svg做排版的项目，所以这里的测量流程借鉴的是浏览器渲染的过程。

渲染模块是针对每一章渲染的结果，返回有多个页面的svg文本。如果遇到某个章节特别大，每一章加载的时间就会特别长，所以有两个方案，一个是现将所有的东西渲染好，保存到磁盘上或者内存中，然后再提供给用户，第二个是针对章节的页做一个基于双向链表的管理器。第一种方案好弄，第二种方案已经有了整体的实现方向了。

首先原本往svg上添加内容是按照段落添加的，所以这里我可以将整个过程拆分，类似react的做法，在加载完一页之后就挂到链表上面，然后在链表上设置最大值，超过这个值的时候进行垃圾回收。
我还想支持笔记功能，支持划线，这个功能的实现主要是为每一个字符都分配一个id，在划线的时候获取对应的dom元素，存储相应的id，在重新加载的时候读取这些id，通过svg的filter标签给字体添加背景等特效。

还有进行多栏渲染，一种实现方法是使用单栏渲染的结果进行拼接，现在已经可以做了。另一种是在一个svg上面渲染多列，我最初的想法是使用svg的g标签将将结果设置到不同的位置，这就需要对我原来的架构进行重构，将内容文本的生成和背景的生成分开，准备多个不同的背景文本，然后使用replace进行替换。这种做法和用单栏结果拼接的不同是减少了重复的svg文本和style标签，因为需要通过style标签控制样式。不过后来我就把这个方案给否定了，因为收益太小，能够节省的存储空间跟最终生成的结果相比太小，但需要做的工作却又太多，投入与产出不成正比。并且把时间花在重构上面就影响了我对其他地方时间的投入，如果能将时间投入到其他地方，我在其他地方可能能想出来更好的方案，要比把时间花在这上面要好得多。

现在在优化一下就差不多了，就能发布了。

还有一个需要解决的一个事情是字符宽度的问题，js里的字符占两个或四个字节，普通的遍历没办法处理四个字节的情况，这就会导致最终的输出会有问题，也会影响字符的id。js原生的处理方法有，通过for of循环，通过array.from将字符串转换为数组进行处理，还有一个是使用codepointat，然后我打算的做法是使用codepointat，fromcodepoint，做一个生成器函数，然后就可以对数组进行遍历，并且可以消除字符串的for of循环没有索引的缺点。

使用双向链表最章节进行管理的时候，一个不好做的点就是，往前翻页的时候，如果前面的章节没有加载，就无法尽快获取到前面章节的最后一页，因为生成的时候只能从前往后加载，这是一个还需要探索的问题。最初一版做的事情是将所有的结果渲染好，然后在这基础上进行操作。

渲染的时候是将字符逐个拼接的，每个字符分配一个text标签，因为这样能最大限度的利用缓存。
渲染英文文件的耗时与中文文件相比是60:14，就是一秒钟可以渲染60kb的英文文件，14kb的中文文件，其中最主要的耗时是测量文本长宽的耗时，因为英文字母就26个，所有需要测量的字符数量可能不超过100个，就可以通过缓存的方式降低总的耗时，中文的字符常用的有2000多，所以测量次数要比英文多很多。现在测量使用的是playwright，后面会将其替换为skiacanvas，测量速度应该要快上很多，在shiki renderer svg这个项目上已经替换完成了，执行测试的速度能快1倍以上。

在选中svg text标签的文本复制的时候，会在每一个字符后面都有一个换行符，因此对代码块来讲，就无法保留原始代码块的换行信息，这里我做的处理是在渲染行结束的时候，在新增一个带有特殊符号的text标签，然后将其长宽置为0，在复制之后，拿到文本时先将换行符替换为空，然后将特殊字符替换为换行就可以保留原始代码的信息。

这个项目与平台无关，只要一门语言有可以解析zip，xml，测量文本长宽，就可以实现这个项目的功能，说的不好听一点，这个项目就是一个字符串拼接项目。

现在已经想好怎样实现倒序渲染了，先对段落进行分行，确保每行的长度不超过给定长度，然后按行倒序逐行渲染。
